<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1.3.1. Create G-OnRamp Virtual Machine Image &#8212; G-OnRamp 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2. Tutorials of G-OnRamp" href="../tutorials.html" />
    <link rel="prev" title="1.2.1. Create G-OnRamp Virtual Machine Image" href="create_virtual_image.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="create-g-onramp-virtual-machine-image">
<h1>1.3.1. Create G-OnRamp Virtual Machine Image<a class="headerlink" href="#create-g-onramp-virtual-machine-image" title="Permalink to this headline">¶</a></h1>
<div class="section" id="requirements">
<h2>1.3.1.1. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Download and install Virtual Box =&gt; <a class="reference external" href="https://www.virtualbox.org">https://www.virtualbox.org</a></li>
<li>Download Ubuntu Server 16.04.1 LTS =&gt; <a class="reference external" href="https://www.ubuntu.com/download/server">https://www.ubuntu.com/download/server</a></li>
</ol>
</div>
<div class="section" id="step-by-step-instruction">
<h2>1.3.1.2. Step by step instruction<a class="headerlink" href="#step-by-step-instruction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="install-ubuntu-server-to-the-virtualbox">
<h3>1.3.1.2.1. 1. Install Ubuntu server to the VirtualBox<a class="headerlink" href="#install-ubuntu-server-to-the-virtualbox" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="http://tecadmin.net/install-ubuntu-on-virtualbox/">How to Install Ubuntu on VirtualBox</a></p>
<p>Additional settings when installing the Ubuntu</p>
<ul class="simple">
<li>Hostname: ubuntus</li>
<li>Full name: galaxyadmin</li>
<li>User name: galaxyadmin</li>
<li>password: 1234</li>
<li>Use entire disk and set up LVM</li>
<li>No proxy configured</li>
<li>Install security updates automatically</li>
<li>Install LAMP server, PostgreSQL database, OpenSSH server</li>
<li>Create new GRUB boot loader</li>
</ul>
</div>
<div class="section" id="initial-ubuntu-setup">
<h3>1.3.1.2.2. 2. Initial Ubuntu setup<a class="headerlink" href="#initial-ubuntu-setup" title="Permalink to this headline">¶</a></h3>
<p>Start the Ubuntu and login in to update the system.</p>
<p>Update packages:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo apt-get update
$ apt-get --with-new-pkgs upgrade
</pre></div>
</div>
<p>Install dependencies:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo apt-get install build-essential
$ sudo apt-get install cmake
$ sudo apt-get install zlib1g-dev
$ reboot
</pre></div>
</div>
</div>
<div class="section" id="set-up-internet-host-only-adapter-used-to-connect-guest-vm-from-host-by-ssh">
<h3>1.3.1.2.3. 3. Set up internet host-only adapter (used to connect guest VM from host by ssh)<a class="headerlink" href="#set-up-internet-host-only-adapter-used-to-connect-guest-vm-from-host-by-ssh" title="Permalink to this headline">¶</a></h3>
<p>Shutdown the virtual machine and add vboxnet0 to Adapter 2 as Host-only Adapter. Then restart the virtual machine.</p>
<a class="reference internal image-reference" href="../_images/network.png"><img alt="add vboxnet0 to Adapter 2" class="align-center" src="../_images/network.png" style="width: 500px;" /></a>
<p>On the host, type command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ifconfig
</pre></div>
</div>
<p>Find the vboxnet0 ip:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">vboxnet0</span><span class="p">:</span> <span class="n">flags</span><span class="o">=</span><span class="mi">8943</span><span class="o">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">PROMISC</span><span class="p">,</span><span class="n">SIMPLEX</span><span class="p">,</span><span class="n">MULTICAST</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span>
<span class="n">ether</span> <span class="mi">0</span><span class="n">a</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">inet</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.1</span> <span class="n">netmask</span> <span class="mh">0xffffff00</span> <span class="n">broadcast</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.255</span>
</pre></div>
</div>
<p>On the Ubuntu guest, list interfaces by typing the command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ip addr
</pre></div>
</div>
<p>You should see three interfaces like lo, enp0s3, enp0s8. We will use the third.</p>
<p>Edit the interfaces file by:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd /etc/network/interfaces
</pre></div>
</div>
<p>Add following enp0s8 configuration to the file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">auto</span> <span class="n">enp0s8</span>
<span class="n">iface</span> <span class="n">enp0s8</span> <span class="n">inet</span> <span class="n">static</span>
<span class="n">address</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.11</span>
<span class="n">netmask</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span>
</pre></div>
</div>
<p>Then activate the interface:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo ifup enp0s8
</pre></div>
</div>
<p>Check if enp0s8 got correct address. You should see your ip by typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ip addr show enp0s8
 ...
inet 192.168.56.11/24 brd 192.168.56.255 scope global secondary enp0s8
</pre></div>
</div>
<p>If not correct, you may run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo ifdown enp0s8
$ sudo ifup enp0s8
$ reboot
</pre></div>
</div>
<p>Now you can access to Ubuntu guest through host by:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ssh galaxyadmin@192.168.56.11
</pre></div>
</div>
</div>
<div class="section" id="install-galaxy">
<h3>1.3.1.2.4. 4. Install galaxy<a class="headerlink" href="#install-galaxy" title="Permalink to this headline">¶</a></h3>
<p>Create a NON-ROOT user called galaxy. Running as an existing user will cause problems down the line when you want to grant or restrict access to data.
$ sudo adduser galaxy
password: 2016
Add galaxy to sudo
$ usermod -aG sudo galaxy
Then login with galaxy
$ su - galaxy</p>
<p>create user for ftp
$ sudo adduser galaxyftp
password: 2016</p>
<p>Make sure Galaxy is using a clean Python interpreter. Conflicts in $PYTHONPATH or the interpreter&#8217;s site-packages/ directory could cause problems. Galaxy manages its own dependencies for the framework, so you do not need to worry about these. The easiest way to do this is with a virtualenv:
$ sudo apt-get update
$ sudo apt-get install python-pip
$ pip install &#8211;upgrade pip
$ sudo pip install virtualenv
$ virtualenv gonramp
$ source gonramp/bin/activate</p>
<p>Galaxy requires a few things to run: a virtualenv, configuration files and dependent python modules. Starting the server at the first time will set these thing up.</p>
<p>Download Galaxy 17.01:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git clone -b release_17.01 https://github.com/galaxyproject/galaxy.git
</pre></div>
</div>
<p># Rename galaxy folder
$ mv galaxy/ galaxy-dist</p>
<p>Configure Galaxy
/
[server:main]
host = 192.168.56.11
filter-with = proxy-prefix
cookie_path = /galaxy</p>
<p>[filter:proxy-prefix]
use = egg:PasteDeploy#prefix
prefix = /gonramp</p>
<p>debug = False
use_interactive = False
Disable filter-with = gzip
cleanup_job = onsuccess</p>
</div>
<div class="section" id="set-up-postgresql-database">
<h3>1.3.1.2.5. Set up PostgreSQL database<a class="headerlink" href="#set-up-postgresql-database" title="Permalink to this headline">¶</a></h3>
<p>$ sudo apt-get update
$ sudo apt-get install postgresql postgresql-contrib
$ sudo -u postgres createuser &#8211;superuser galaxy
$ sudo -u galaxy createdb galaxy
$ psql -u galaxy
$ password 1234
In galaxy.init, set:
database_connection = postgresql://galaxy:1234&#64;localhost/galaxy</p>
<p>Run Galaxy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd galaxy
$ sh run.sh
</pre></div>
</div>
</div>
<div class="section" id="set-up-proxy-nginx">
<h3>1.3.1.2.6. Set up proxy nginx<a class="headerlink" href="#set-up-proxy-nginx" title="Permalink to this headline">¶</a></h3>
<p># Install nginx from pre-build package. Not flexible
ref: <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-16-04#step-3-check-your-web-server">https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-16-04#step-3-check-your-web-server</a></p>
<p>$ sudo systemctl stop apache2.service
$ sudo apt-get update
$ sudo apt-get install nginx
$ sudo apt-get install nginx-extras</p>
<p># To remove nginx
# $ sudo apt-get remove nginx nginx-common # Removes all but config files.
# $ sudo apt-get purge nginx nginx-common # Removes everything.
# After using any of the above commands, use this in order to remove dependencies used by nginx which are no longer required.
# $ sudo apt-get autoremove</p>
<p># Install nginx from source
# ref: <a class="reference external" href="https://www.nginx.com/resources/admin-guide/installing-nginx-open-source/">https://www.nginx.com/resources/admin-guide/installing-nginx-open-source/</a>
# Install zlib
# $ wget <a class="reference external" href="http://zlib.net/zlib-1.2.11.tar.gz">http://zlib.net/zlib-1.2.11.tar.gz</a>
# $ tar -zxf zlib-1.2.11.tar.gz
# $ cd zlib-1.2.11
# $ ./configure
# $ make
# $ sudo make install
#
# Install openssl
# $ wget <a class="reference external" href="http://www.openssl.org/source/openssl-1.0.2f.tar.gz">http://www.openssl.org/source/openssl-1.0.2f.tar.gz</a>
# $ tar -zxf openssl-1.0.2f.tar.gz
# $ cd openssl-1.0.2f
# $ ./configure &#8211;prefix=/usr
# $ make
# $ sudo make install
#
# Connecting to VM via FTP
# Check the network adapter 1. change it to &#8220;Bridged&#8221;
# $ reboot</p>
<p># Common used commands
# ref: <a class="reference external" href="http://nginx.org/en/docs/beginners_guide.html">http://nginx.org/en/docs/beginners_guide.html</a>
# nginx -s signal
# Where signal may be one of the following:
# stop — fast shutdown
# quit — graceful shutdown
# reload — reloading the configuration file
# reopen — reopening the log files
# example: nginx -s reload</p>
<p>#add server block,
$ cd /etc/nginx/site-available
$ sudo vim galaxy
# add following server block to galaxy file
server {</p>
<blockquote>
<div><p>listen 80;
root /var/www/html;
# maximum file upload size
client_max_body_size 10G;</p>
<p># pass most requests to the proxied Galaxy application
location /gonramp {</p>
<blockquote>
<div>proxy_pass        <a class="reference external" href="http://192.168.56.11:8080">http://192.168.56.11:8080</a>;
proxy_set_header    X-Forwarded-Host $host;
proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</div></blockquote>
<p>}</p>
<p># directly serve static content in nginx
location /gonramp/static {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static;
expires 24h;</div></blockquote>
<p>}
location /gonramp/static/style {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static/style/blue;
expires 24h;</div></blockquote>
<p>}
location /gonramp/static/scripts {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static/scripts;
expires 24h;</div></blockquote>
<p>}
location /gonramp/robots.txt {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static/robots.txt;
expires 24h;</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<p># enable galaxy server
$ cd /etc/nginx/site-enabled
$ sudo ln -s /etc/nginx/site-available/galaxy</p>
<p>#Make sure that you either comment out or modify line containing default configuration for enabled sites. in /etc/nginx/nginx.conf, include /etc/nginx/sites-enabled/<a href="#id1"><span class="problematic" id="id2">*</span></a>;
$ cd /etc/nginx/site-enabled
$ rm default</p>
<p># Change the root of nginx to /var/www/html/nginx, in order to distinct from apache page
# $ cd /etc/nginx/site-available
# $ sudo vim galaxy #change root to /var/www/html/nginx
# $ cd /var/www/html
# $ sudo mkdir /var/www/html/nginx
# $ mv index.nginx-debian.html nginx/
# $ sudo systemctl restart nginx</p>
</div>
<div class="section" id="rotate-log-files">
<h3>1.3.1.2.7. Rotate log files<a class="headerlink" href="#rotate-log-files" title="Permalink to this headline">¶</a></h3>
<p>To use logrotate to rotate Galaxy log files, add a new file named &#8220;galaxy&#8221; to /etc/logrotate.d/ directory with something like:</p>
<dl class="docutils">
<dt>PATH_TO_GALAXY_LOG_FILES {</dt>
<dd>weekly
rotate 8
copytruncate
compress
missingok
notifempty</dd>
</dl>
<p>}</p>
</div>
<div class="section" id="set-up-galaxy">
<h3>1.3.1.2.8. 6. Set up Galaxy<a class="headerlink" href="#set-up-galaxy" title="Permalink to this headline">¶</a></h3>
<div class="section" id="set-proxy">
<h4>1.3.1.2.8.1. Set proxy<a class="headerlink" href="#set-proxy" title="Permalink to this headline">¶</a></h4>
<p>Galaxy application needs to be aware that it is running with a prefix (for generating URLs in dynamic pages). This is accomplished by configuring a Paste proxy-prefix filter in the [app:main] section of config/galaxy.ini and restarting Galaxy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">server</span><span class="p">:</span><span class="n">main</span><span class="p">]</span>
  <span class="n">host</span> <span class="o">=</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.11</span>
<span class="p">[</span><span class="nb">filter</span><span class="p">:</span><span class="n">proxy</span><span class="o">-</span><span class="n">prefix</span><span class="p">]</span>
  <span class="n">use</span> <span class="o">=</span> <span class="n">egg</span><span class="p">:</span><span class="n">PasteDeploy</span><span class="c1">#prefix</span>
  <span class="n">prefix</span> <span class="o">=</span> <span class="o">/</span><span class="n">gonramp</span>
<span class="p">[</span><span class="n">app</span><span class="p">:</span><span class="n">main</span><span class="p">]</span>
  <span class="nb">filter</span><span class="o">-</span><span class="k">with</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">-</span><span class="n">prefix</span>
  <span class="n">cookie_path</span> <span class="o">=</span> <span class="o">/</span><span class="n">gonramp</span>
</pre></div>
</div>
</div>
<div class="section" id="become-an-admin">
<h4>1.3.1.2.8.2. Become an Admin<a class="headerlink" href="#become-an-admin" title="Permalink to this headline">¶</a></h4>
<p>In order to install tools, you have to become administrator for your Galaxy instance. First start the server, go to <a class="reference external" href="http://192.168.56.11:8080/gonramp">http://192.168.56.11:8080/gonramp</a>, and register as a new user with your email address.</p>
<p>#username: <a class="reference external" href="mailto:galaxyadmin&#37;&#52;&#48;gonramp&#46;org">galaxyadmin<span>&#64;</span>gonramp<span>&#46;</span>org</a>
# public name: galaxyadmin
#password: 12341234</p>
<p>Go to galaxy folder and find a sub-folder called config. Add a new file named galaxy.init in the config folder. You can copy the content of galaxy.init.sample into galaxy.init. In galaxy.init, search for the line containing “admin_users”. Add your user email address to admin users. (Replace None to your email address). You can add multiple admin users by appending another email and separating them with a comma:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># this should be a comma-separated list of valid Galaxy users</span>
<span class="n">admin_users</span> <span class="o">=</span> <span class="n">galaxyadmin</span><span class="nd">@gonramp</span><span class="o">.</span><span class="n">org</span>
</pre></div>
</div>
</div>
<div class="section" id="set-up-conda">
<h4>1.3.1.2.8.3. Set up conda<a class="headerlink" href="#set-up-conda" title="Permalink to this headline">¶</a></h4>
<p>In galaxy.init, uncomment and edit the following conda configuration:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">conda_ensure_channels</span> <span class="o">=</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">bioconda</span><span class="p">,</span><span class="n">iuc</span>
<span class="n">conda_auto_install</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">conda_auto_init</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="section" id="connect-your-galaxy-to-the-test-tool-shed">
<h4>1.3.1.2.8.4. Connect your Galaxy to the test tool shed<a class="headerlink" href="#connect-your-galaxy-to-the-test-tool-shed" title="Permalink to this headline">¶</a></h4>
<p>Galaxy is connected to the Main Tool Shed by default. Since some tools in G-OnRamp workflow are in the Test Tool Shed, you need to connect to the Test Tool Shed by modifying the “tool_sheds_conf.xml” in config folder:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span># Copy the “tool_sheds_conf.xml.sample” and rename it to “tool_sheds_conf.xml”
$ cd /home/galaxy/config
$ cp tool_sheds_conf.xml.sample tool_sheds_conf.xml
# Open the file
$ vim tool_sheds_conf.xml
</pre></div>
</div>
<p>Uncomment the lines for the Test Tool Shed:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;tool_sheds&gt;
  &lt;tool_shed name=&quot;Galaxy Main Tool Shed&quot; url=&quot;https://toolshed.g2.bx.psu.edu/&quot;/&gt;
&lt;!-- Test Tool Shed should be used only for testing purposes.
  &lt;tool_shed name=&quot;Galaxy Test Tool Shed&quot; url=&quot;https://testtoolshed.g2.bx.psu.edu/&quot;/&gt;
--&gt;
&lt;/tool_sheds&gt;
</pre></div>
</div>
<p>To:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;tool_sheds&gt;
  &lt;tool_shed name=&quot;Galaxy Main Tool Shed&quot; url=&quot;https://toolshed.g2.bx.psu.edu/&quot;/&gt;
  &lt;tool_shed name=&quot;Galaxy Test Tool Shed&quot; url=&quot;https://testtoolshed.g2.bx.psu.edu/&quot;/&gt;
&lt;/tool_sheds&gt;
</pre></div>
</div>
</div>
<div class="section" id="add-necessary-datatypes">
<h4>1.3.1.2.8.5. Add necessary datatypes<a class="headerlink" href="#add-necessary-datatypes" title="Permalink to this headline">¶</a></h4>
<p>Copy the “datatypes_conf.xml.sample” and rename it to “datatypes_conf.xml”.
Add the line below in between &lt;registration&gt;&lt;/registration&gt;:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">datatype</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;psl&quot;</span> <span class="n">subclass</span><span class="o">=</span><span class="s2">&quot;True&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;galaxy.datatypes.tabular:Tabular&quot;</span> <span class="o">/&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="other-files-should-be-ready-copy-from-sample">
<h4>1.3.1.2.8.6. Other files should be ready (copy from .sample)<a class="headerlink" href="#other-files-should-be-ready-copy-from-sample" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cp dependency_resolvers_conf.xml.sample dependency_resolvers_conf.xml
</pre></div>
</div>
<p>Restart the server after you modified the configuration files. You can hit Ctrl-c to stop the server and then start again.</p>
</div>
</div>
<div class="section" id="install-g-onramp-tools">
<h3>1.3.1.2.9. 7. Install G-OnRamp tools<a class="headerlink" href="#install-g-onramp-tools" title="Permalink to this headline">¶</a></h3>
<p>Go to Admin page, and click on Search Tool Shed. Click on the Tool Sheds to search and install. You can add all G-OnRamp tools in a separate panel section by adding a new tool panel section when you install the first tool and then add all the rest tools in the same panel.</p>
<div class="section" id="click-on-galaxy-main-tool-shed-to-install">
<h4>1.3.1.2.9.1. Click on Galaxy Main Tool Shed to install<a class="headerlink" href="#click-on-galaxy-main-tool-shed-to-install" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>ncbi_blast_plus (by devteam)</li>
<li>Augustus</li>
<li>HISAT2</li>
<li>StringTie</li>
<li>blastXmlToPsl</li>
<li>TrfBig</li>
<li>pslToBed</li>
<li>bamtobigwig (by yating-l)</li>
<li>hubarchivecreator</li>
<li>multi_fasta_glimmer_hmm</li>
<li>snap</li>
<li>psltobigpsl (by yating-l)</li>
<li>jbrowsearchivecreator</li>
<li>gbtofasta</li>
<li>regtools_junctions_extract (by yating-l)</li>
<li>rename_scaffolds</li>
<li>ucsc_blat</li>
<li>ucsc_pslcdnafilter</li>
<li>uscs_pslpostarget</li>
<li>uscs_pslcheck</li>
</ul>
</div>
<div class="section" id="tools-need-advanced-configuration">
<h4>1.3.1.2.9.2. Tools need advanced configuration<a class="headerlink" href="#tools-need-advanced-configuration" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>multi_fasta_glimmer_hmm</li>
</ol>
<p>Make a Dependencies folder in &#8220;/home/galaxy&#8221; and download Glimmer3 inside the folder by:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ mkdir Dependencies
$ cd ~/Dependencies
$ wget ftp://ccb.jhu.edu/pub/software/glimmerhmm/GlimmerHMM-3.0.4.tar.gz
</pre></div>
</div>
<p>Rename glimmerhmm executable file (glimmerhmm_linux_x86_64) to glimmerhmm and then add glimmerhmm to the path (in .bashrc).</p>
<p>You also need to use a trained organism by adding them as reference data in Galaxy:</p>
<p>Add the glimmer_hmm_trained_dir data table to tool_data_table_conf.xml in $GALAXY_ROOT/config/:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;!-- glimmer_hmm trained_dir --&gt;
&lt;table name=&quot;glimmer_hmm_trained_dir&quot; comment_char=&quot;#&quot;&gt;
  &lt;columns&gt;value, name, path&lt;/columns&gt;
  &lt;file path=&quot;tool-data/glimmer_hmm.loc&quot; /&gt;
&lt;/table&gt;
</pre></div>
</div>
<p>Add the glimmer_hmm.loc file referencing your trained organism, in tool-data. Uncomment the species and add the path to trained_dir.</p>
<ol class="arabic simple" start="2">
<li>TrfBig</li>
</ol>
<p>Because trf executable file is not renamed to trf successfully, so it needs to be renamed manually.</p>
<p>Go to installation path of trf:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd /home/galaxy/galaxy/database/dependencies/trf/4.07b/rmarenco/trfbig/e45bd0ffc1a4/bin
$ mv trf407b.linux64 trf
$ chmod 755 trf
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Bam to Bigwig</li>
</ol>
<p>libstdc++.so.6: version <a href="#id3"><span class="problematic" id="id4">`</span></a>GLIBCXX_3.4.20&#8217; not found, maybe because it is not using the right libstdc++.so.6. Delete the installed libstdc++.so.6 in the tool dependencies, so that the tool can use the system version of libstdc++.so.6:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd /home/galaxy/galaxy/database/dependencies/ucsc_tools/312/iuc/package_ucsc_tools_312/2d6bafd63401/lib/
$ rm libstdc++.so.6
</pre></div>
</div>
</div>
</div>
<div class="section" id="ftp-server">
<h3>1.3.1.2.10. FTP server<a class="headerlink" href="#ftp-server" title="Permalink to this headline">¶</a></h3>
<p>ref: <a class="reference external" href="https://galaxyproject.org/admin/config/upload-via-ftp/">https://galaxyproject.org/admin/config/upload-via-ftp/</a></p>
<p>in the config file, galaxy.init, set
ftp_upload_dir = /home/galaxy/galaxy-dist/database/files/
ftp_upload_site = 192.168.56.11</p>
</div>
</div>
</div>
<div class="section" id="allow-your-ftp-server-to-read-galaxy-s-database">
<h1>1.3.2. Allow your FTP server to read Galaxy&#8217;s database<a class="headerlink" href="#allow-your-ftp-server-to-read-galaxy-s-database" title="Permalink to this headline">¶</a></h1>
<p>You&#8217;ll need to grant a user access to read emails and passwords from the Galaxy database. Although the user Galaxy connects with could be used, I prefer to use a least-privilege setup wherein a separate user is created for the FTP server which has permission to SELECT from the galaxy_user table and nothing else. In postgres this is accomplished with:</p>
<p>postgres&#64;dbserver% createuser -SDR galaxyftp
postgres&#64;dbserver% psql galaxydb
Welcome to psql 8.X.Y, the PostgreSQL interactive terminal.</p>
<dl class="docutils">
<dt>Type:  copyright for distribution terms</dt>
<dd>h for help with SQL commands
? for help with psql commands
g or terminate with semicolon to execute query
q to quit</dd>
</dl>
<p>galaxydb=# ALTER ROLE galaxyftp PASSWORD &#8216;dbpassword&#8217;;
ALTER ROLE
galaxydb=# GRANT SELECT ON galaxy_user TO galaxyftp;
GRANT</p>
</div>
<div class="section" id="set-up-ftp-server">
<h1>1.3.3. set up FTP server<a class="headerlink" href="#set-up-ftp-server" title="Permalink to this headline">¶</a></h1>
<p>ref:https://kyup.com/tutorials/install-setup-ftp-server-proftpd/</p>
<p>$ sudo apt-get install proftpd
$ sudo apt-get install proftpd-mod-psql
$ sudo nano /etc/proftpd/proftpd.conf</p>
<p>When we are ready with the configuration we can start up the ProFTPD server:
$ sudo /etc/init.d/proftpd start
or $ sudo service proftpd restart
Make sure that the default FTP port 21 is opened on the server:
$ sudo iptables -A INPUT -p tcp &#8211;dport 21 -j ACCEPT
$ sudo iptables-save
Start Up ProFTPD automatically on server boot
$ sudo update-rc.d proftpd defaults</p>
<p>Configure /etc/proftpd/proftpd.conf:</p>
<p>#********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
#********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************</p>
<p>Includes DSO modules
Include /etc/proftpd/modules.conf</p>
<p># Basics, some site-specific
ServerName                      &#8220;Public Galaxy FTP&#8221;
ServerType                      standalone
DefaultServer                   on
Port                            21
Umask                           022
SyslogFacility                 DAEMON
SyslogLevel                    debug
MaxInstances                    30
User                            galaxy
Group                           galaxy</p>
<p># Passive port range for the firewall
PassivePorts                    30000 40000</p>
<p># Cause every FTP user to be &#8220;jailed&#8221; (chrooted) into their home directory
DefaultRoot                     ~</p>
<p># Automatically create home directory if it doesn&#8217;t exist
CreateHome                      on dirmode 700</p>
<p># Allow users to overwrite their files
AllowOverwrite                  on</p>
<p># Allow users to resume interrupted uploads
AllowStoreRestart               on</p>
<p># Bar use of SITE CHMOD
&lt;Limit SITE_CHMOD&gt;</p>
<blockquote>
<div>DenyAll</div></blockquote>
<p>&lt;/Limit&gt;</p>
<p># Bar use of RETR (download) since this is not a public file drop
&lt;Limit RETR&gt;</p>
<blockquote>
<div>DenyAll</div></blockquote>
<p>&lt;/Limit&gt;</p>
<p># Do not authenticate against real (system) users
AuthPAM                         off</p>
<p># Set up mod_sql_password - Galaxy passwords are stored as hex-encoded SHA1
SQLPasswordEngine               on
SQLPasswordEncoding             base64
SQLPasswordPBKDF2               SHA256 10000 24
SQLPasswordUserSalt             sql:/GetUserSalt</p>
<p># Set up mod_sql to authenticate against the Galaxy database
SQLEngine                       on
SQLBackend                      postgres
SQLConnectInfo                  <a class="reference external" href="mailto:galaxy&#37;&#52;&#48;/var/run/postgresql">galaxy<span>&#64;</span>/var/run/postgresql</a> galaxy 1234
SQLAuthTypes                    PBKDF2
SQLAuthenticate                 users</p>
<p># An empty directory in case chroot fails
SQLDefaultHomedir               /var/opt/local/proftpd</p>
<p># Define a custom query for lookup that returns a passwd-like entry. Replace 512s with the UID and GID of the user running the Galaxy server
SQLUserInfo                     custom:/LookupGalaxyUser
SQLNamedQuery                   LookupGalaxyUser SELECT &#8220;email, (CASE WHEN substring(password from 1 for 6) = &#8216;PBKDF2&#8217; THEN substring(password from 38 for 69) ELSE password END) AS password2,1001,1001,&#8217;/home/galaxy/galaxy-dist/database/ftp/%U&#8217;,&#8217;/bin/bash&#8217; FROM galaxy_user WHERE email=&#8217;%U&#8217;&#8221;
SQLNamedQuery                   GetUserSalt SELECT &#8220;(CASE WHEN SUBSTRING (password from 1 for 6) = &#8216;PBKDF2&#8217; THEN SUBSTRING (password from 21 for 16) END) AS salt FROM galaxy_user WHERE email=&#8217;%U&#8217;&#8221;</p>
<p>#********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
#********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************</p>
<p>Configure /etc/proftpd/modules.conf, add :
#********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
LoadModule mod_sql.c
LoadModule mod_sql_passwd.c
LoadModule mod_sql_postgres.c
LoadModule mod_sftp_sql.c
#********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************</p>
<p>#see docker filesystem:
#docker run &#8211;rm -it &#8211;entrypoint=/bin/bash bgruening/galaxy-stable</p>
<p>#ref: <a class="reference external" href="https://galaxyproject.org/admin/config/performance/scaling/">https://galaxyproject.org/admin/config/performance/scaling/</a>
#ref2: <a class="reference external" href="https://galaxyproject.org/events/bio-it-world2014/w14/">https://galaxyproject.org/events/bio-it-world2014/w14/</a></p>
<p>#Enable multiple cores in the virtual environment
Stop the VM and go to Settings -&gt; System -&gt; Process
#(<a class="reference external" href="https://www.virtualbox.org/manual/ch03.html">https://www.virtualbox.org/manual/ch03.html</a>)
Change the processors number and check &#8220;Enable PAE/NX&#8221;, as &#8220;Some operating systems (such as Ubuntu Server) require PAE support from the CPU and cannot be run in a virtual machine without it.&#8221;</p>
</div>
<div class="section" id="set-up-uwsgi">
<h1>1.3.4. Set up uWSGI<a class="headerlink" href="#set-up-uwsgi" title="Permalink to this headline">¶</a></h1>
<p>#In galaxy.ini, define one or more [server:...] sections:</p>
<p>[server:web0]
use = egg:Paste#http
port = 8080
host = 192.168.56.11
use_threadpool = True
threadpool_workers = 7</p>
<p>[server:web1]
use = egg:Paste#http
port = 8081
host = 192.168.56.11
use_threadpool = True
threadpool_workers = 7
#Two are shown, you should create as many as are suitable for your usage and hardware. On our eight-core server, I run six web server processes. You may find you only need one, which is a slightly simpler configuration.</p>
<p>#In galaxy.ini, define a [uwsgi] section:</p>
<p>[uwsgi]
processes = 4
stats = 192.168.56.11:9191
socket = 192.168.56.11:4001
pythonpath = lib
threads = 4
logto = /home/galaxy/gonramp/logs/uwsgi.log #anywhere you like
master = True</p>
<p>#Port numbers for stats and socket can be adjusted as desired. Moreover, in the [app:main] section, you must set:</p>
<p>static_enabled = False
track_jobs_in_database = True</p>
<p># Install wusgi
# use pip install in the virtual environment
$ source gonramp/bin/activate
$ pip install uwsgi</p>
<p>#The web processes can then be started under uWSGI using:
$ cd /path/to/galaxy-dist
$ PYTHONPATH=eggs/PasteDeploy-1.5.0-py2.7.egg uwsgi &#8211;ini-paste config/galaxy.ini
#Once started, a proxy server (typically Apache or nginx) must be configured to proxy requests to uWSGI (using uWSGI&#8217;s native protocol). Configuration details for these can be found in Proxy section.</p>
</div>
<div class="section" id="job-handler-s">
<h1>1.3.5. Job Handler(s)<a class="headerlink" href="#job-handler-s" title="Permalink to this headline">¶</a></h1>
<p>#In galaxy.ini, define one or more additional [server:...] sections:</p>
<p>[server:handler0]
use = egg:Paste#http
port = 8090
host = 192.168.56.11
use_threadpool = true
threadpool_workers = 5</p>
<p>[server:handler1]
use = egg:Paste#http
port = 8091
host = 192.168.56.11
use_threadpool = true
threadpool_workers = 5</p>
</div>
<div class="section" id="configure-job-conf-xml">
<h1>1.3.6. Configure job_conf.xml<a class="headerlink" href="#configure-job-conf-xml" title="Permalink to this headline">¶</a></h1>
<p># uncomment in galaxy.init
job_config_file = config/job_conf.xml
#job configuration <a class="reference external" href="https://galaxyproject.org/admin/config/jobs/">https://galaxyproject.org/admin/config/jobs/</a>
&lt;?xml version=&#8221;1.0&#8221;?&gt;
&lt;!&#8211; A sample job config that explicitly configures job running the way it is configured by default (if there is no explicit config). &#8211;&gt;
&lt;job_conf&gt;</p>
<blockquote>
<div><dl class="docutils">
<dt>&lt;plugins workers=&#8221;2&#8221;&gt;</dt>
<dd>&lt;plugin id=&#8221;gridengine&#8221; type=&#8221;runner&#8221; load=&#8221;galaxy.jobs.runners.drmaa:DRMAAJobRunner&#8221;/&gt;</dd>
</dl>
<p>&lt;/plugins&gt;
&lt;handlers default=&#8221;handlers&#8221;&gt;</p>
<blockquote>
<div>&lt;handler id=&#8221;handler0&#8221; tags=&#8221;handlers&#8221;/&gt;
&lt;handler id=&#8221;handler1&#8221; tags=&#8221;handlers&#8221;/&gt;</div></blockquote>
<p>&lt;/handlers&gt;
&lt;destinations default=&#8221;gridengine&#8221;&gt;</p>
<blockquote>
<div>&lt;destination id=&#8221;gridengine&#8221; runner=&#8221;gridengine&#8221;/&gt;</div></blockquote>
<p>&lt;/destinations&gt;
&lt;limits&gt;</p>
<blockquote>
<div>&lt;limit type=&#8221;registered_user_concurrent_jobs&#8221;&gt;2&lt;/limit&gt;
&lt;limit type=&#8221;unregistered_user_concurrent_jobs&#8221;&gt;1&lt;/limit&gt;
&lt;limit type=&#8221;job_walltime&#8221;&gt;24:00:00&lt;/limit&gt;</div></blockquote>
<p>&lt;/limits&gt;</p>
</div></blockquote>
<p>&lt;/job_conf&gt;</p>
</div>
<div class="section" id="install-and-configure-grid-engine">
<h1>1.3.7. Install and configure Grid Engine<a class="headerlink" href="#install-and-configure-grid-engine" title="Permalink to this headline">¶</a></h1>
<p>$ sudo apt-get install gridengine-master gridengine-exec gridengine-client gridengine-drmaa1.0</p>
<p>#You&#8217;ll be asked a series of configuration questions for Postfix and Grid Engine at this point. The following answers are suitable for this workshop:</p>
<p>General type of mail configuration: Local only
System mail name: galaxy
Configure SGE automatically?: Yes
SGE cell name: default
SGE master hostname: galaxy</p>
</div>
<div class="section" id="start-and-stop-with-supervisord">
<h1>1.3.8. Start and Stop with supervisord<a class="headerlink" href="#start-and-stop-with-supervisord" title="Permalink to this headline">¶</a></h1>
<p>#Since you need to run multiple processes, the typical run.sh method for starting and stopping Galaxy won&#8217;t work. The current recommended way to manage these multiple processes is with Supervisord.
# install supervisor in virtualenv
$ pip install supervisor
# Creating a Configuration File
echo_supervisord_conf &gt; /etc/supervisord.conf
# Configure
$ vim /etc/supervisord.conf
# add program galaxy_uwsgi, handler and group section</p>
<p>[program:galaxy_uwsgi]
command = /home/galaxy/gonramp/bin/uwsgi &#8211;virtualenv /home/galaxy/galaxy-dist/.venv &#8211;ini-paste /home/galaxy/galaxy-dist/config/galaxy.ini
directory = /home/galaxy/galaxy-dist
umask = 022
autostart = true
autorestart = true
startsecs = 20
user = galaxy
environment = PATH=/home/galaxy/galaxy-dist/.venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin, PYTHONHOME=/home/galaxy/galaxy-dist/.venv
numprocs = 1
stopsignal = INT
startretries = 15</p>
<p>[program:handler]
command = /home/galaxy/galaxy-dist/.venv/bin/python ./lib/galaxy/main.py -c ./config/galaxy.ini &#8211;server-name=handler%(process_num)s &#8211;log-file=/home/galaxy/galaxy-dist/handler%(process_num)s.log
directory = /home/galaxy/galaxy-dist
process_name = handler%(process_num)s
numprocs = 2
unmask = 022
autostart = true
autorestart = true
startsecs = 20
user = galaxy
environment = PYTHONHOME=/home/galaxy/galaxy-dist/.venv
;PYTHON_EGG_CACHE = /home/galaxy/galaxy-dist/.python-eggs, DRMAA_LIBRARY_PATH=/usr/lib/gridengine-drmaa/lib/libdrmaa.so.1.0, SGE_ROOT=/var/lib/gridengine</p>
<p>[group:galaxy]
programs = handler, galaxy_uwsgi</p>
<p># Start the program
$ supervisorctl start galaxy:*
# Check status
$ supervisorctl status
# Log file
$ tail -f /tmp/supervisord.log</p>
</div>
<div class="section" id="proxy-uwsgi-with-nginx">
<h1>1.3.9. Proxy uWSGI with nginx<a class="headerlink" href="#proxy-uwsgi-with-nginx" title="Permalink to this headline">¶</a></h1>
<p># add server block below in /etc/nginx/nginx.conf and comment
#include /etc/nginx/sites-enabled/<a href="#id5"><span class="problematic" id="id6">*</span></a>;
server {</p>
<blockquote>
<div><p>listen 80;
root /var/www/html;
# maximum file upload size
client_max_body_size 10G;
uwsgi_read_timeout 180;
location /gonramp {</p>
<blockquote>
<div>include uwsgi_params;
uwsgi_pass 192.168.56.11:4001;
uwsgi_param UWSGI_SCHEME $scheme;</div></blockquote>
<p>}
# directly serve static content in nginx
location /gonramp/static {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static;
expires 24h;</div></blockquote>
<p>}
location /gonramp/static/style {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static/style/blue;
expires 24h;</div></blockquote>
<p>}
location /gonramp/static/scripts {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static/scripts;
expires 24h;</div></blockquote>
<p>}
location /gonramp/favicon.ico {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static/favicon.ico;
expires 24h;</div></blockquote>
<p>}
location /gonramp/robots.txt {</p>
<blockquote>
<div>alias /home/galaxy/galaxy-dist/static/robots.txt;
expires 24h;</div></blockquote>
<p>}</p>
</div></blockquote>
<p>}</p>
<p># Restart nginx
$ server restart nginx</p>
</div>
<div class="section" id="access-to-gonramp">
<h1>1.3.10. Access to gonramp<a class="headerlink" href="#access-to-gonramp" title="Permalink to this headline">¶</a></h1>
<p>$ supervisorctl start galaxy:*
#Goto http://192.168.56.11/gonramp</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../installation.html">1. Installation of G-OnRamp</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installation.html#g-onramp-virtual-machine">1.1. G-OnRamp virtual machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-g-onramp-virtual-machine">1.2. Create G-OnRamp virtual machine</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../installation.html#id1">1.3. Create G-OnRamp virtual machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#g-onramp-website">1.4. G-OnRamp website</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">2. Tutorials of G-OnRamp</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../installation.html">1. Installation of G-OnRamp</a><ul>
      <li>Previous: <a href="create_virtual_image.html" title="previous chapter">1.2.1. Create G-OnRamp Virtual Machine Image</a></li>
      <li>Next: <a href="../tutorials.html" title="next chapter">2. Tutorials of G-OnRamp</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/installation/create_virtual_image_production.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Yating Liu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../_sources/installation/create_virtual_image_production.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>